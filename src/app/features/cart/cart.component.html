<section class="bg-linear-to-br from-slate-50 to-gray-100 min-h-screen py-8 px-4">
    <div class="container mx-auto max-w-7xl">
        <div class="grid lg:grid-cols-3 gap-8">

            <!-- Cart Products Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <!-- Cart Header -->
                    <div class="bg-linear-to-r from-teal-600 to-cyan-600 p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/20 backdrop-blur-sm p-3 rounded-xl">
                                    <i class="fas fa-shopping-cart text-2xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold">Shopping Cart</h1>
                                    <p class="text-teal-100 text-sm">Review your items</p>
                                </div>
                            </div>
                            @if (cartDetailsData().products) {
                                <div class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full">
                                    <span class="text-lg font-semibold">{{cartDetailsData().products.length}}</span>
                                    <span class="text-sm ml-1">items</span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Cart Items -->
                    <div class="p-6">
                        @for (item of cartDetailsData().products; track item.product._id) {
                            <div class="group bg-white border border-gray-200 rounded-xl p-4 mb-4 hover:shadow-lg transition-all duration-300 hover:border-teal-300 hover:scale-[1.01]">
                                <div class="grid md:grid-cols-12 gap-4">
                                    <!-- Product Image -->
                                    <div class="md:col-span-3">
                                        <div class="relative overflow-hidden rounded-lg bg-gray-100 aspect-square">
                                            <img [src]="item.product.imageCover" [alt]="item.product.title" 
                                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                                            <div class="absolute top-2 right-2 bg-teal-600 text-white text-xs px-2 py-1 rounded-full font-semibold">
                                                {{item.count}}x
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Product Details -->
                                    <div class="md:col-span-9">
                                        <div class="flex flex-col h-full justify-between">
                                            <div>
                                                <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">{{item.product.title}}</h3>
                                                <div class="flex items-center gap-2 mb-3">
                                                    <span class="text-2xl font-bold text-teal-600">{{item.price * item.count | currency:'GBP'}}</span>
                                                    <span class="text-sm text-gray-500">{{item.price | currency:'GBP'}} each</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex flex-wrap items-center gap-3">
                                                <div class="flex items-center bg-gray-50 border border-gray-300 rounded-lg overflow-hidden shadow-sm">
                                                    <button (click)="updateProductCount(item.product._id, item.count - 1)" 
                                                            class="px-3 py-2 bg-white hover:bg-teal-600 hover:text-white transition-all duration-200 border-r border-gray-300">
                                                        <i class="fas fa-minus text-sm"></i>
                                                    </button>
                                                    <span class="px-4 py-2 font-semibold min-w-[60px] text-center bg-gray-50">{{item.count}}</span>
                                                    <button (click)="updateProductCount(item.product._id, item.count + 1)" 
                                                            class="px-3 py-2 bg-white hover:bg-teal-600 hover:text-white transition-all duration-200 border-l border-gray-300">
                                                        <i class="fas fa-plus text-sm"></i>
                                                    </button>
                                                </div>
                                                <button (click)="RemoveProductFromCart(item.product._id)" 
                                                        class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-600 hover:text-white transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md">
                                                    <i class="fas fa-trash-can"></i>
                                                    <span class="hidden sm:inline">Remove</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        @empty {
                            <div class="text-center py-16">
                                <div class="inline-flex items-center justify-center w-24 h-24 bg-gray-100 rounded-full mb-4">
                                    <i class="fas fa-shopping-basket text-4xl text-gray-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-2">Your cart is empty</h3>
                                <p class="text-gray-500 mb-6">Add some products to get started!</p>
                                <button class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition-colors duration-200">
                                    Continue Shopping
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Order Summary Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden sticky top-4">
                    <div class="bg-linear-to-r from-purple-600 to-pink-600 p-6 text-white">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <i class="fas fa-receipt"></i>
                            Order Summary
                        </h2>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <!-- Price Breakdown -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-semibold">{{cartDetailsData().totalCartPrice | currency:'GBP'}}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600">Shipping</span>
                                <span class="font-semibold text-green-600">Free</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600">Tax</span>
                                <span class="font-semibold">{{(cartDetailsData().totalCartPrice * 0.2) | currency:'GBP'}}</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-lg font-bold text-gray-800">Total</span>
                                <span class="text-2xl font-bold text-teal-600">{{(cartDetailsData().totalCartPrice * 1.2) | currency:'GBP'}}</span>
                            </div>
                        </div>

                        <!-- Promo Code -->
                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex gap-2">
                                <input type="text" placeholder="Promo code" 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                                    Apply
                                </button>
                            </div>
                        </div>

                        <!-- Payment Options -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <!-- Cash on Delivery Button -->
                            <button (click)="toggleCashPaymentForm()" 
                                    class="w-full bg-linear-to-r from-green-600 to-emerald-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg mb-3">
                                <i class="fas fa-money-bill-wave mr-2"></i>
                                Pay with Cash on Delivery
                            </button>

                            <!-- Cash Payment Form -->
                            @if (showCashPaymentForm()) {
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-truck text-green-600"></i>
                                        Delivery Information
                                    </h3>
                                    
                                    <form [formGroup]="cashPaymentForm" (ngSubmit)="processCashPayment()" class="space-y-4">
                                        <!-- Address Details -->
                                        <div>
                                            <label for="details" class="block text-sm font-semibold text-gray-700 mb-2">
                                                <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>
                                                Address Details
                                            </label>
                                            <textarea formControlName="details" id="details" rows="3"
                                                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                                      placeholder="Enter your complete address"></textarea>
                                            
                                            @let detailsControl = cashPaymentForm.get('shippingAddress.details');
                                            @if(detailsControl?.errors && detailsControl?.touched) {
                                                <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                                        <span>Address details are required</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Phone Number -->
                                        <div>
                                            <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
                                                <i class="fas fa-phone mr-2 text-green-600"></i>
                                                Phone Number
                                            </label>
                                            <input formControlName="phone" type="tel" id="phone"
                                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                                   placeholder="+20 1xxxxxxxxx">
                                            
                                            @let phoneControl = cashPaymentForm.get('shippingAddress.phone');
                                            @if(phoneControl?.errors && phoneControl?.touched) {
                                                <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                                        <div>
                                                            @if(phoneControl?.getError('required')) {
                                                                <span>Phone number is required</span>
                                                            } @else if(phoneControl?.getError('pattern')) {
                                                                <span>Enter a valid Egyptian phone number</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- City -->
                                        <div>
                                            <label for="city" class="block text-sm font-semibold text-gray-700 mb-2">
                                                <i class="fas fa-city mr-2 text-green-600"></i>
                                                City
                                            </label>
                                            <input formControlName="city" type="text" id="city"
                                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                                   placeholder="Enter your city">
                                            
                                            @let cityControl = cashPaymentForm.get('shippingAddress.city');
                                            @if(cityControl?.errors && cityControl?.touched) {
                                                <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-exclamation-circle mr-2"></i>
                                                        <span>City is required</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Submit Cash Order Button -->
                                        <button type="submit" [disabled]="isProcessingCashPayment()"
                                                class="w-full bg-linear-to-r from-green-600 to-emerald-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                            @if(isProcessingCashPayment()) {
                                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                                Processing Order...
                                            } @else {
                                                <i class="fas fa-check-circle mr-2"></i>
                                                Place Cash Order
                                            }
                                        </button>
                                    </form>
                                </div>
                            }
                        </div>

                        <!-- Checkout Button (for card payment) -->
                        @if (!showCashPaymentForm()) {
                            <div class="border-t border-gray-200 pt-4">
                                <button [routerLink]="['/checkout', cartDetailsData()._id]" 
                                        class="w-full bg-linear-to-r from-teal-600 to-cyan-600 text-white py-4 rounded-xl font-semibold hover:from-teal-700 hover:to-cyan-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
                                    <i class="fas fa-credit-card mr-2"></i>
                                    Proceed to Card Payment
                                </button>
                            </div>
                        }

                        <!-- Security Info -->
                        <div class="flex items-center justify-center gap-4 text-xs text-gray-500 pt-2">
                            <span class="flex items-center gap-1">
                                <i class="fas fa-shield-alt"></i>
                                Secure
                            </span>
                            <span class="flex items-center gap-1">
                                <i class="fas fa-truck"></i>
                                Fast Delivery
                            </span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>